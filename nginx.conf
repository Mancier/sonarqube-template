
server {
  listen   80;
  server_name sonarqube.domain;

  location / {
      rewrite  ^https://$host$request_uri? permanent;
  }
}

server {
  listen        443 ssl http2 default_server;
  listen        [::]:443 ssl http2;

  server_name   sonarqube.domain;
  ssl_certificate     /app/certs/cert.pem;
  ssl_certificate_key /app/certs/privkey.pem;
  ssl_protocols       TLSv1 TLSv1.1 TLSv1.2;
  ssl_ciphers         ECDH+AESGCM:ECDH+AES256:ECDH+AES128:DHE+AES128:!ADH:!AECDH:!MD5;
  ssl_prefer_server_ciphers on;

  proxy_set_header   Host                 $http_host;
  proxy_set_header   X-Forwarded-Proto    $scheme;
  proxy_set_header   X-Forwarded-For      $remote_addr;
  proxy_redirect     off;

  # keepalive + raven.js is a disaster
  keepalive_timeout 0;

  # use very aggressive timeouts
  proxy_read_timeout 5s;
  proxy_send_timeout 5s;
  send_timeout 5s;
  resolver_timeout 5s;
  client_body_timeout 5s;

  # buffer larger messages
  client_max_body_size 5m;
  client_body_buffer_size 100k;

  location / {
    proxy_pass  http://sonarqube:9000;

    add_header Strict-Transport-Security "max-age=31536000";
  }
}
